#!/usr/bin/env python3
"""
upload_checkpoint_to_hf.py
==========================
通用上传脚本：将本地 Qwen2/LLM 权重 (单文件或分片目录) 以及 tokenizer/config 一并上传到 Hugging Face Hub。

用法示例 (bash)：
    python scripts/upload_checkpoint_to_hf.py \
        --model-path merged_actor_model_correct/model.safetensors \
        --config-dir checkpoints/ufo/test/global_step_200/actor/huggingface \
        --repo-name LichengLiu03/qwen2.5-3b-UFO-1turn \
        --token $HF_TOKEN

参数说明：
    --model-path   必填，模型文件 (model.safetensors) 或包含分片与 index.json 的目录。
    --config-dir   可选，包含 tokenizer.json / config.json 等的目录；若省略且 --model-path
                   是目录，则自动把该目录作为 config 源。
    --repo-name    目标 Hugging Face 仓库名 (username/model-name)。
    --token        Hugging Face 访问令牌。
    --private      (flag) 创建私有仓库。
"""

import argparse
import os
import sys
from pathlib import Path
from typing import List

from huggingface_hub import HfApi, upload_file, upload_folder


def parse_args() -> argparse.Namespace:
    p = argparse.ArgumentParser(description="Upload checkpoint & configs to HF Hub")
    p.add_argument("--model-path", required=True, help="Path to model.safetensors or shard directory")
    p.add_argument("--config-dir", help="Directory containing tokenizer/config files")
    p.add_argument("--repo-name", required=True, help="HF repo (username/model)")
    p.add_argument("--token", required=True, help="HF token (env var or string)")
    p.add_argument("--private", action="store_true", help="Create private repo")
    return p.parse_args()


def gather_config_files(config_dir: Path) -> List[Path]:
    patterns = [
        "config.json",
        "generation_config.json",
        "tokenizer.json",
        "tokenizer_config.json",
        "vocab.json",
        "merges.txt",
        "special_tokens_map.json",
        "added_tokens.json",
        "chat_template.jinja",
    ]
    files: List[Path] = []
    for name in patterns:
        f = config_dir / name
        if f.exists():
            files.append(f)
    return files


def main() -> None:
    args = parse_args()

    model_path = Path(args.model_path).expanduser().resolve()
    if not model_path.exists():
        sys.exit(f"❌ model-path 不存在: {model_path}")

    # config-dir 推断
    config_dir = Path(args.config_dir).expanduser().resolve() if args.config_dir else None
    if config_dir is None:
        if model_path.is_dir():
            config_dir = model_path  # 直接用同一目录
        else:
            sys.exit("❌ 未指定 --config-dir，且 --model-path 不是目录，无法确定 tokenizer/config")
    else:
        if not config_dir.exists():
            sys.exit(f"❌ config-dir 不存在: {config_dir}")

    print(f"Model path : {model_path}")
    print(f"Config dir : {config_dir}")
    print(f"Repo name  : {args.repo_name}")

    api = HfApi(token=args.token)
    api.create_repo(
        repo_id=args.repo_name,
        repo_type="model",
        exist_ok=True,
        private=args.private,
    )

    # 上传模型权重
    if model_path.is_dir():
        print("Uploading weight directory (may take a while)…")
        upload_folder(
            folder_path=str(model_path),
            repo_id=args.repo_name,
            repo_type="model",
            token=args.token,
            commit_message="Upload model weights directory",
        )
    else:
        print("Uploading single model.safetensors file…")
        upload_file(
            path_or_fileobj=str(model_path),
            path_in_repo="model.safetensors",
            repo_id=args.repo_name,
            repo_type="model",
            token=args.token,
            commit_message="Upload single model.safetensors",
        )

    # 上传配置 / tokenizer
    cfg_files = gather_config_files(config_dir)
    if cfg_files:
        print(f"Uploading {len(cfg_files)} tokenizer/config files…")
        for f in cfg_files:
            upload_file(
                path_or_fileobj=str(f),
                path_in_repo=f.name,
                repo_id=args.repo_name,
                repo_type="model",
                token=args.token,
                commit_message=f"Add {f.name}",
            )
    else:
        print("⚠️ 未找到任何 tokenizer/config 文件，已跳过。")

    print("✅ Upload finished!")


if __name__ == "__main__":
    main() 
